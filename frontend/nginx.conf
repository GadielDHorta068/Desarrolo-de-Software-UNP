server {
    listen 4200;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    gzip on;
    gzip_types text/plain text/css application/javascript application/json application/xml+rss image/svg+xml;

    # Backend directo (sin proxy externo)
    location ^~ /auth/ { proxy_pass http://backend:8080/auth/; proxy_http_version 1.1; }
    location = /auth { proxy_pass http://backend:8080/auth; proxy_http_version 1.1; }
    location ^~ /events/ { proxy_pass http://backend:8080/events/; proxy_http_version 1.1; }
    location = /events { proxy_pass http://backend:8080/events; proxy_http_version 1.1; }
    location ^~ /categories/ { proxy_pass http://backend:8080/categories/; proxy_http_version 1.1; }
    location = /categories { proxy_pass http://backend:8080/categories; proxy_http_version 1.1; }
    location ^~ /images/ { proxy_pass http://backend:8080/api/images/; proxy_http_version 1.1; }
    location = /images { proxy_pass http://backend:8080/api/images; proxy_http_version 1.1; }
    location ^~ /audit/ { proxy_pass http://backend:8080/audit/; proxy_http_version 1.1; }
    location = /audit { proxy_pass http://backend:8080/audit; proxy_http_version 1.1; }
    # Rutas SPA /chat/* y /chat: servir desde index.html, no proxyear al backend

    # API de chat: mapear /api/chat/* al backend directamente
    location ^~ /api/chat/ { proxy_pass http://backend:8080/api/chat/; proxy_http_version 1.1; }
    location = /api/chat { proxy_pass http://backend:8080/api/chat; proxy_http_version 1.1; }

    location ^~ /url/ { proxy_pass http://backend:8080/api/url/; proxy_http_version 1.1; }
    location = /url { proxy_pass http://backend:8080/api/url; proxy_http_version 1.1; }
    location ^~ /registered-users/ { proxy_pass http://backend:8080/api/registered-users/; proxy_http_version 1.1; }
    location = /registered-users { proxy_pass http://backend:8080/api/registered-users; proxy_http_version 1.1; }
    location ^~ /2fa/ { proxy_pass http://backend:8080/2fa/; proxy_http_version 1.1; }
    location = /2fa { proxy_pass http://backend:8080/2fa; proxy_http_version 1.1; }

    # WebSocket directo
    location /ws {
        proxy_pass http://backend:8080/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location / {
        try_files $uri $uri/ /index.html;
    }

    location ~* \.(?:ico|css|js|gif|jpe?g|png|svg|woff2?)$ {
        expires 30d;
        access_log off;
    }
}
